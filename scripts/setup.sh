#!/usr/bin/env bash
# First-time setup: collect credentials and create .env
# Run once on the VPS after cloning the repo.
# Usage: bash scripts/setup.sh
set -euo pipefail

cd "$(dirname "$0")/.."

if [ -f .env ]; then
  echo "ERROR: .env already exists. Delete it first if you want to regenerate."
  exit 1
fi

command -v openssl >/dev/null 2>&1 || { echo "ERROR: openssl is required"; exit 1; }
command -v docker  >/dev/null 2>&1 || { echo "ERROR: docker is required — install it first"; exit 1; }

echo ""
echo "=== obsidian-claude-code setup ==="
echo ""

read -rp "Enter your domain (e.g. claude.example.com): " DOMAIN
if [ -z "$DOMAIN" ]; then
  echo "ERROR: domain cannot be empty"
  exit 1
fi

echo ""
echo "Google OAuth credentials"
echo "  1. Go to https://console.cloud.google.com/apis/credentials"
echo "  2. Create an OAuth 2.0 Client ID (Web application)"
echo "  3. Add this Authorized Redirect URI:"
echo "       https://${DOMAIN}/api/auth/callback"
echo ""
read -rp "Google Client ID:     " GOOGLE_CLIENT_ID
if [ -z "$GOOGLE_CLIENT_ID" ]; then
  echo "ERROR: GOOGLE_CLIENT_ID cannot be empty"
  exit 1
fi
read -rp "Google Client Secret: " GOOGLE_CLIENT_SECRET
if [ -z "$GOOGLE_CLIENT_SECRET" ]; then
  echo "ERROR: GOOGLE_CLIENT_SECRET cannot be empty"
  exit 1
fi

echo ""
read -rp "Your Google email address (the only account allowed to log in): " ALLOWED_EMAIL
if [ -z "$ALLOWED_EMAIL" ]; then
  echo "ERROR: ALLOWED_EMAIL cannot be empty"
  exit 1
fi

APP_SECRET=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -hex 32)

cat > .env <<EOF
# Generated by scripts/setup.sh — keep this file secret, never commit it.

APP_SECRET=${APP_SECRET}
ENCRYPTION_KEY=${ENCRYPTION_KEY}

# Google OAuth — only ALLOWED_EMAIL can log in
GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ALLOWED_EMAIL=${ALLOWED_EMAIL}

# Domain — used for Caddy TLS and the OAuth redirect URI
PUBLIC_DOMAIN=${DOMAIN}
PUBLIC_URL=https://${DOMAIN}

DATABASE_URL=/data/app.db
VAULTS_DIR=/var/vault
NODE_ENV=production
PORT=3000
EOF

echo ""
echo ".env created successfully."
echo ""
echo "Next steps:"
echo "  1. Make sure DNS A record for ${DOMAIN} points to this server's IP"
echo "  2. Run: docker compose up -d --build"
echo "  3. Open https://${DOMAIN} and sign in with your Google account"
echo "  4. Complete the two-step setup wizard (Claude token + vault path)"
echo ""
