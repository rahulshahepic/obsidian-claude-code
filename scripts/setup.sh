#!/usr/bin/env bash
# First-time setup: generate secrets and create .env
# Run once on the VPS after cloning the repo.
# Usage: bash scripts/setup.sh
set -euo pipefail

cd "$(dirname "$0")/.."

if [ -f .env ]; then
  echo "ERROR: .env already exists. Delete it first if you want to regenerate."
  exit 1
fi

command -v openssl >/dev/null 2>&1 || { echo "ERROR: openssl is required"; exit 1; }
command -v docker  >/dev/null 2>&1 || { echo "ERROR: docker is required — install it first"; exit 1; }

echo ""
echo "=== obsidian-claude-code setup ==="
echo ""

read -rp "Enter your domain (e.g. claude.example.com): " DOMAIN
if [ -z "$DOMAIN" ]; then
  echo "ERROR: domain cannot be empty"
  exit 1
fi

APP_SECRET=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -hex 32)
SETUP_TOKEN=$(openssl rand -hex 16)

cat > .env <<EOF
# Generated by scripts/setup.sh — keep this file secret, never commit it.

APP_SECRET=${APP_SECRET}
ENCRYPTION_KEY=${ENCRYPTION_KEY}

# One-time token required to complete the setup wizard.
# Anyone who visits the site before setup is done would otherwise be able to
# register their own passkey and take over your instance.
SETUP_TOKEN=${SETUP_TOKEN}

# Domain — used for Caddy TLS and WebAuthn rpID
PUBLIC_DOMAIN=${DOMAIN}
PUBLIC_URL=https://${DOMAIN}

DATABASE_URL=/data/app.db
VAULTS_DIR=/var/vault
NODE_ENV=production
PORT=3000
EOF

echo ""
echo ".env created successfully."
echo ""
echo "┌─────────────────────────────────────────────────────┐"
echo "│  SETUP TOKEN — you will need this to complete setup │"
echo "│                                                     │"
echo "│  ${SETUP_TOKEN}  │"
echo "│                                                     │"
echo "│  Keep it private. It's also saved in .env          │"
echo "└─────────────────────────────────────────────────────┘"
echo ""
echo "Next steps:"
echo "  1. Make sure DNS A record for ${DOMAIN} points to this server's IP"
echo "  2. Run: docker compose up -d --build"
echo "  3. Open https://${DOMAIN} and complete the setup wizard"
echo "     (you'll need the setup token printed above)"
echo ""
