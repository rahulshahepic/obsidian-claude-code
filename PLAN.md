# Obsidian Claude Code — Architecture Plan (v2)

## What This Is

A self-hosted web app (PWA) that **one person deploys on their own VPS** to run Claude Code
sessions from their phone, with their Obsidian vault synced via Git. You chat with Claude Code
in a mobile browser, it reads/writes your vault, and the Obsidian app syncs changes via the
Obsidian Git plugin.

**Single-user, self-hosted.** You deploy it for yourself. No accounts, no multi-tenancy.

---

## What Changed From v1 (and Why)

The original plan assumed users could link their claude.ai subscription via OAuth to run Claude
Code on your server on their behalf. This is **explicitly prohibited by Anthropic's ToS** (updated
Feb 17-18 2026): third-party developers may not offer claude.ai login or subscription rate limits
for their products — and GitHub issue #6536 requesting SDK support for this was closed as
"not planned."

**New model**: Each person deploys their own instance. They authenticate their own Claude
account during the one-time setup wizard. Their subscription is used by their own VPS — no
third party involved, just you running Claude Code on a computer you own.

Side effects of this pivot:
- No Google OAuth, no multi-user system, no admin panel
- No per-user isolation complexity
- The whole codebase is dramatically simpler
- The deploy story becomes "clone, run setup, done"

---

## Design Decisions

### 1. Mobile-First PWA
Every screen is designed for a phone screen. Nothing assumes a mouse or wide viewport.
Safe area insets, touch targets ≥ 44px, proper `apple-mobile-web-app-*` tags.

### 2. Single-User, Passkey-Protected (WebAuthn)
The setup wizard registers a **Passkey** — a hardware-backed key pair generated by your phone's
secure enclave. No password to create, remember, or leak. Future logins use Face ID / Touch ID /
biometrics via the browser's native WebAuthn API. A session cookie (30-day, HttpOnly, Secure) is
issued after successful authentication.

Libraries: `@simplewebauthn/server` (Node) + `@simplewebauthn/browser` (client).
The public key and credential ID are stored in the `config` table (single user = single
credential). If you lose your device, re-registration is done directly from the VPS via a
one-time CLI command (`npm run reset-auth`) which clears the stored credential.

### 3. Claude Auth via OAuth Setup Page
On first setup, the wizard walks you through authenticating with your Claude account.
The VPS initiates the CLI's PKCE OAuth flow. Since the callback URI is fixed to
`https://console.anthropic.com/oauth/code/callback` (Anthropic-controlled), we use a
**two-phase approach**:

- **Primary (browser-initiated)**: VPS generates PKCE params + state. You're redirected to
  `claude.ai/oauth/authorize`. After you authenticate, Anthropic's callback page handles the
  code. The VPS polls a known Anthropic endpoint using the `state` value to retrieve the
  authorization code (replicating the CLI's internal polling mechanism — to be reverse-engineered
  from the CLI binary or confirmed via network traffic inspection).

- **Fallback (token paste)**: If the polling mechanism can't be confirmed, the setup wizard
  shows a "run this command and paste the result" step: `claude setup-token`. This is
  Anthropic's own headless mechanism and always works. The VPS stores the token as
  `CLAUDE_CODE_OAUTH_TOKEN`.

The VPS stores credentials in `~/.claude/credentials.json` (same format as the CLI) or in
the app's SQLite config. Token refresh is handled via the refresh token.

### 4. Claude Agent SDK — Host-Side
The `@anthropic-ai/claude-agent-sdk` runs on the VPS host. It spawns Claude Code CLI as a
subprocess. Two integration points matter here:

- **`options.env`** — this is where `CLAUDE_CODE_OAUTH_TOKEN` is injected per session
- **`options.canUseTool`** — async callback that resolves to allow/deny. This is how permission
  prompts work: the callback suspends the session and sends a `permission_request` event over
  WebSocket; when the user taps Allow/Deny on their phone, the callback resolves.

There is no `apiKey` param — credentials are entirely env-based.

### 5. Docker for Tool Execution Isolation
The SDK spawns the Claude Code CLI as a subprocess. That CLI's Bash tool runs shell commands
on the host — which is unacceptable on a shared machine. Solution: `pathToClaudeCodeExecutable`
is set to a wrapper script that runs `claude` **inside a Docker container** via `docker exec`.

The VPS maintains one persistent "workspace container" (or one per active session). The container
has Python, Node.js, Git, all standard tools, and the user's vault mounted. The host-side SDK
communicates with the containerised CLI via subprocess stdin/stdout (docker exec -i bridges this
naturally).

Resource limits are applied at container creation time.

### 6. Full Claude Code Experience
Same as before: streaming text, tool call cards, file diffs, `/commands`, and permission prompts
with approve/deny on mobile.

---

## Architecture

```
┌──────────────────────────────────────────────────────────┐
│  Phone                                                   │
│  ┌──────────────┐   ┌────────────────────────────────┐  │
│  │ Obsidian App │   │ Chrome/Safari PWA               │  │
│  │ + Git plugin │   │  Chat UI                        │  │
│  │              │   │  Settings                        │  │
│  │              │   │  Setup wizard (first run)        │  │
│  └──────┬───────┘   └──────────────┬─────────────────┘  │
└─────────┼──────────────────────────┼────────────────────┘
          │ git push/pull            │ WebSocket + HTTPS
          ▼                          ▼
┌──────────────────────────────────────────────────────────┐
│  Your VPS (Ubuntu 24.04)                                 │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ Caddy  (reverse proxy, auto-HTTPS, port 443)     │   │
│  └──────────────────────┬─────────────────────────┘    │
│                         │                                │
│  ┌──────────────────────▼─────────────────────────┐    │
│  │ SvelteKit App  (Node, port 3000/3001)            │    │
│  │                                                  │    │
│  │  Pages                                           │    │
│  │    /          → chat UI (login-gated)            │    │
│  │    /setup     → first-time setup wizard          │    │
│  │    /login     → password entry                   │    │
│  │    /settings  → Claude auth status, vault config │    │
│  │    /monitor   → system health, usage stats       │    │
│  │                                                  │    │
│  │  API routes                                      │    │
│  │    /api/auth/register    WebAuthn registration   │    │
│  │    /api/auth/login       WebAuthn authentication │    │
│  │    /api/health           JSON health check       │    │
│  │    /api/setup/*          setup wizard steps      │    │
│  │    /api/session/*        start/stop/status       │    │
│  │    /api/ws               WebSocket upgrade        │    │
│  └──────────────────────┬─────────────────────────┘    │
│                         │                                │
│  ┌──────────────────────▼─────────────────────────┐    │
│  │ Session Manager (in-process Node.js module)     │    │
│  │  - Calls @anthropic-ai/claude-agent-sdk query() │    │
│  │  - pathToClaudeCodeExecutable → docker-exec.sh  │    │
│  │  - canUseTool → WebSocket permission round-trip  │    │
│  │  - Bridges SDK message stream → WebSocket        │    │
│  │  - CLAUDE_CODE_OAUTH_TOKEN injected via env      │    │
│  └───────────────────────┬──────────────────────┘     │
│                          │ docker exec -i               │
│  ┌───────────────────────▼──────────────────────┐     │
│  │ Workspace Container (Docker)                  │     │
│  │  ubuntu:24.04                                 │     │
│  │  claude (CLI binary)                          │     │
│  │  Python 3 + pip + uv                          │     │
│  │  Node.js + npm                                │     │
│  │  Git, ripgrep, fd, jq, curl                   │     │
│  │  /vault  ← bind-mounted from host             │     │
│  │  Resource limits: memory, CPU, pids           │     │
│  └───────────────────────────────────────────────┘     │
│                                                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ SQLite  ./data/app.db                            │   │
│  │  config: key, value  (credentials, vault path)   │   │
│  │  sessions: id, started_at, ended_at, status      │   │
│  └──────────────────────────────────────────────────┘   │
│                                                          │
│  /var/vault/  ← git bare repo (Obsidian pushes here)    │
└──────────────────────────────────────────────────────────┘
```

---

## Tech Stack

| Layer | Choice | Reason |
|---|---|---|
| Frontend + API | SvelteKit | Small bundle, fast on mobile, great PWA support |
| Styling | Tailwind CSS | Utility-first, enforces mobile-first discipline |
| Auth | Passkeys / WebAuthn | Hardware-backed biometric auth, no password to leak |
| Claude auth | Claude.ai OAuth (own account) | Your subscription, your VPS, no ToS issue |
| Claude SDK | `@anthropic-ai/claude-agent-sdk` | Official SDK with `canUseTool`, streaming, env injection |
| Container | Docker (single workspace container) | Bash tool isolation, Python/Node environment |
| Container bridge | `pathToClaudeCodeExecutable` wrapper | SDK on host, Claude CLI in container |
| Database | SQLite via Drizzle ORM | Zero-config, no network, perfect for single-user |
| Reverse proxy | Caddy | Auto-HTTPS, one-line config |
| Vault sync | Git bare repo on VPS | Obsidian Git plugin push/pulls natively |

---

## Project Structure

```
obsidian-claude-code/
├── PLAN.md
├── docker-compose.yml          ← single compose file (dev flag = build target)
├── Caddyfile
├── .env.example
│
├── container/
│   ├── Dockerfile              ← workspace container image
│   ├── entrypoint.sh
│   └── docker-exec-wrapper.sh  ← script set as pathToClaudeCodeExecutable
│
└── app/
    ├── package.json
    ├── svelte.config.js
    ├── vite.config.ts
    ├── src/
    │   ├── app.html             ← PWA meta tags
    │   ├── service-worker.ts
    │   │
    │   ├── lib/
    │   │   ├── server/
    │   │   │   ├── db/
    │   │   │   │   ├── schema.ts
    │   │   │   │   └── index.ts
    │   │   │   ├── auth/
    │   │   │   │   └── webauthn.ts    ← SimpleWebAuthn server, session cookie
    │   │   │   ├── claude/
    │   │   │   │   ├── oauth.ts       ← PKCE flow, token polling, token refresh
    │   │   │   │   └── session-manager.ts ← query() wrapper, canUseTool bridge
    │   │   │   ├── docker.ts          ← container lifecycle (start, exec, stop)
    │   │   │   ├── monitor.ts         ← system stats: CPU/mem/disk, container status
    │   │   │   └── git.ts             ← bare repo init/management
    │   │   │
    │   │   ├── components/
    │   │   │   ├── chat/
    │   │   │   │   ├── MessageList.svelte
    │   │   │   │   ├── Message.svelte
    │   │   │   │   ├── DiffViewer.svelte
    │   │   │   │   ├── PermissionPrompt.svelte  ← approve/deny sheet
    │   │   │   │   ├── ToolCallCard.svelte
    │   │   │   │   └── CommandBar.svelte
    │   │   │   └── ui/              ← Button, Sheet, Badge, etc.
    │   │   │
    │   │   └── ws-protocol.ts     ← TypeScript types for all WebSocket messages
    │   │
    │   └── routes/
    │       ├── +layout.svelte     ← mobile shell, auth guard
    │       ├── +page.svelte       ← chat UI
    │       ├── login/
    │       │   └── +page.svelte   ← WebAuthn authenticate
    │       ├── setup/
    │       │   └── +page.svelte   ← wizard (passkey → claude auth → vault)
    │       ├── settings/
    │       │   └── +page.svelte   ← claude auth status, vault URL, refresh token
    │       ├── monitor/
    │       │   └── +page.svelte   ← system health, usage stats
    │       └── api/
    │           ├── auth/
    │           │   ├── register/+server.ts   ← WebAuthn registration ceremony
    │           │   └── login/+server.ts      ← WebAuthn authentication ceremony
    │           ├── health/
    │           │   └── +server.ts   ← JSON health check (unauthenticated)
    │           ├── setup/
    │           │   ├── claude/start/+server.ts   ← initiate PKCE, return OAuth URL
    │           │   ├── claude/poll/+server.ts     ← poll for auth completion
    │           │   └── vault/+server.ts
    │           ├── session/
    │           │   └── +server.ts
    │           └── ws/
    │               └── +server.ts  ← WebSocket upgrade
    │
    └── static/
        ├── manifest.json
        └── icons/
```

---

## Claude Auth Flow (OAuth Setup Page)

The `container/docker-exec-wrapper.sh` sets `pathToClaudeCodeExecutable` so the SDK's subprocess
runs inside Docker. Separately, Claude credentials are managed by the VPS:

### Phase 1 implementation (reliable fallback): Token paste

```
Setup wizard step 2:

  "Authenticate with Claude"

  1. Click "Open Claude in browser" →
     opens https://claude.ai/oauth/authorize?client_id=9d1c250a-...&...

  2. Complete login in browser

  3. In a terminal on your local machine, run:
       claude setup-token
     Copy the token shown.

  4. Paste token here: [________________]
     [ Save ]
```

The VPS stores it as `CLAUDE_CODE_OAUTH_TOKEN` in the config table (encrypted).

### Phase 2 (future): Full polling-based browser OAuth

Once the CLI's state-polling mechanism is confirmed (by inspecting CLI network traffic), the
wizard can be fully browser-driven with no copy-paste step. The VPS will:
1. Generate PKCE params + state, return OAuth URL to browser
2. User completes OAuth in browser (redirect goes to console.anthropic.com)
3. VPS polls `https://console.anthropic.com/api/oauth/pending?state=<state>` (or equivalent)
   until it receives the authorization code
4. VPS exchanges code + code_verifier for access + refresh tokens
5. Store credentials, proceed to next setup step

---

## Docker Container Bridge

`container/docker-exec-wrapper.sh`:
```bash
#!/bin/bash
# Called by @anthropic-ai/claude-agent-sdk as the Claude Code executable.
# Forwards all arguments and stdin/stdout to the workspace container.
exec docker exec -i claude-workspace claude "$@"
```

Session manager sets:
```typescript
import { query } from "@anthropic-ai/claude-agent-sdk";

for await (const msg of query({
  prompt: userMessage,
  options: {
    pathToClaudeCodeExecutable: "/opt/obsidian-claude-code/docker-exec-wrapper.sh",
    cwd: "/vault",
    env: {
      CLAUDE_CODE_OAUTH_TOKEN: storedOAuthToken,
    },
    permissionMode: "default",   // triggers canUseTool for sensitive operations
    canUseTool: async (tool, input) => {
      // suspend and send permission_request over WebSocket
      // await user approve/deny on phone
      return awaitPermissionFromWebSocket(tool, input);
    },
  }
})) {
  // forward msg to WebSocket client
}
```

---

## WebSocket Protocol

All messages are JSON. Connection requires `Authorization: Bearer <session-token>` header or
`?token=` query param (the session token from the login cookie).

### Server → Client

```ts
{ type: 'text',              content: string }
{ type: 'tool_start',        tool: string, input: Record<string, unknown> }
{ type: 'tool_end',          tool: string, output: string }
{ type: 'permission_request', id: string, tool: string, command: string, description: string }
{ type: 'diff',              file: string, patch: string }
{ type: 'session_state',     state: 'idle' | 'running' | 'waiting_permission' | 'error' | 'done' }
{ type: 'cost',              total_usd: number }
{ type: 'error',             message: string }
```

### Client → Server

```ts
{ type: 'message',             content: string }
{ type: 'permission_response', id: string, allow: boolean }
{ type: 'interrupt' }
```

---

## Database Schema (Drizzle + SQLite)

```ts
// Key-value config store
config {
  key    text primary key   // e.g. 'password_hash', 'oauth_token', 'vault_path'
  value  text               // encrypted for sensitive keys
}

// Session history
sessions {
  id           text primary key   // uuid
  started_at   integer
  ended_at     integer
  status       text    // 'running' | 'stopped' | 'error'
  turn_count   integer
  cost_usd     real
}
```

That's the entire schema. No users table. No per-user anything.

---

## Workspace Container (Dockerfile)

```dockerfile
FROM ubuntu:24.04

RUN apt-get update && apt-get install -y \
    curl git python3 python3-pip python3-venv \
    ripgrep fd-find jq wget unzip \
    && rm -rf /var/lib/apt/lists/*

# Node.js LTS
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
    && apt-get install -y nodejs

# uv (fast Python package manager)
RUN curl -LsSf https://astral.sh/uv/install.sh | sh

# Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Non-root user
RUN useradd -m -s /bin/bash claude
USER claude
WORKDIR /home/claude

VOLUME /vault
```

Container is started once and kept alive across sessions (no startup latency):
```
docker run -d \
  --name claude-workspace \
  --memory=1g \
  --cpus=1.0 \
  --pids-limit=200 \
  --network=claude-net \
  -v /var/vault:/vault \
  claude-workspace-image
```

---

## Docker Compose

Single `docker-compose.yml` with a `DEV=true` env flag to toggle dev vs prod settings:

```yaml
services:
  app:
    build: ./app
    volumes:
      - ./data:/data          # SQLite
      - /var/run/docker.sock:/var/run/docker.sock  # to manage workspace container
      - ./container/docker-exec-wrapper.sh:/usr/local/bin/docker-exec-wrapper.sh
    environment:
      - DATABASE_URL=/data/app.db
      - VAULTS_DIR=/var/vault
    ports:
      - "3000:3000"

  caddy:
    image: caddy:2-alpine
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
    ports:
      - "80:80"
      - "443:443"
```

---

## Setup Wizard Flow

```
First visit (not set up):
  /setup
    Step 1: Choose password
            [password] [confirm] → POST /api/setup/password
    Step 2: Authenticate with Claude
            Two options:
            a) [Open Claude OAuth] → opens claude.ai OAuth in new tab
               wait for completion (polling) → show ✓ when done
            b) "Or paste a token from 'claude setup-token'"
               [token input] → POST /api/setup/claude/token
    Step 3: Configure vault
            Git remote URL the Obsidian app should push to:
            [  https://your-vps.com/vault.git  ]  (auto-filled, read-only)
            [Done]
  → redirect to /

Subsequent visits:
  /login
    [password] → 30-day session cookie → redirect to /
```

---

## Key Env Vars (`.env.example`)

```
# Required
APP_SECRET=           # random 32+ char string for signing cookies
ENCRYPTION_KEY=       # random 32-byte hex for encrypting tokens at rest
DATABASE_URL=/data/app.db

# Domain (used by Caddy + OAuth callback)
PUBLIC_URL=https://your-vps.example.com

# Vault
VAULTS_DIR=/var/vault

# Optional overrides
PORT=3000
NODE_ENV=production
```

No Google credentials, no Claude OAuth client ID/secret (we use the CLI's public client).

---

## Monitoring

### `/api/health` — unauthenticated JSON endpoint
For external uptime monitors (UptimeRobot, Betterstack, etc.).

```json
{
  "status": "ok",
  "uptime_seconds": 43200,
  "setup_complete": true,
  "container_status": "running",
  "claude_token_valid": true,
  "claude_token_expires_in_seconds": 14400,
  "vault_last_push": "2026-02-22T08:15:00Z",
  "version": "0.1.0"
}
```

Returns `503` with `"status": "degraded"` if container is not running or token is expired.

### `/monitor` — authenticated PWA page
Mobile dashboard showing:

| Section | Metrics |
|---|---|
| **System** | VPS CPU %, RAM used/total, disk used/total |
| **Container** | Status (running/stopped), uptime, restart button |
| **Current session** | Active?, model, turns, cost so far |
| **Usage (30 days)** | Total sessions, total cost USD, avg session length |
| **Vault** | Last push timestamp, branch, uncommitted file count |
| **Claude auth** | Token expires in, last refreshed, "Re-authenticate" button |

`monitor.ts` reads from:
- `/proc/meminfo` + `/proc/stat` — host CPU/RAM
- `df` syscall or `/proc/mounts` — disk usage
- Docker Engine API (`/var/run/docker.sock`) — container status
- SQLite sessions table — usage aggregates

---

## Implementation Phases

### Phase 1 — Foundation
1. SvelteKit app scaffold: Tailwind, PWA manifest, iOS meta tags
2. Drizzle schema (config + sessions tables) + SQLite setup
3. Passkey auth: `@simplewebauthn/server`, session cookie, route guard
4. Setup wizard: passkey registration step (Claude auth stubbed)
5. `/api/health` endpoint
6. `/` renders a placeholder chat UI (not yet functional)
7. `docker-compose.yml` dev setup

### Phase 2 — Claude Auth
1. `claude/oauth.ts`: PKCE generation, OAuth URL construction
2. Setup wizard Claude auth step (token-paste path first)
3. Token storage (encrypted in config table)
4. Token refresh logic (access token expires in 8h, refresh token long-lived)
5. Settings page: show auth status, "re-authenticate" button

### Phase 3 — Container + Session Manager
1. Workspace container Dockerfile
2. `docker-exec-wrapper.sh`
3. `docker.ts`: start/stop/exec container lifecycle
4. `session-manager.ts`: `query()` integration, `canUseTool` WebSocket bridge
5. WebSocket server (`/api/ws`): auth check, message routing

### Phase 4 — Chat UI
1. Message list with streaming text
2. Tool call cards (collapsible, shows tool name + input)
3. Permission prompt (bottom sheet, approve/deny)
4. Diff viewer (mobile unified diff)
5. `/command` slash input
6. Session state indicator + cost display

### Phase 5 — Vault / Git
1. Git bare repo at `/var/vault`
2. Git HTTP backend via Caddy (or SSH — TBD based on Obsidian Git plugin support)
3. Container vault mount at session start
4. Settings page: show the push URL, copy button

### Phase 6 — OAuth Polling (Phase 2 upgrade)
1. Reverse-engineer CLI polling mechanism (network inspection of `claude auth` run)
2. Implement `setup/claude/start` + `setup/claude/poll` server routes
3. Add fully browser-based auth path to setup wizard (no terminal step)

### Phase 7 — Monitor Page
1. `monitor.ts`: host CPU/RAM from `/proc`, disk usage, Docker socket stats
2. `/monitor` PWA page: system panel, usage panel, vault status, token status
3. Auto-refresh every 30s

### Phase 8 — Production Hardening
1. `docker-compose.yml` prod target
2. Caddy config with HTTPS
3. Container resource limits (memory, CPU, PIDs)
4. Network isolation (`claude-net` bridge, no host access)
5. Log rotation, startup script / systemd unit

---

## Decisions Still Open

- **Git auth for vault sync**: HTTPS (basic auth via Caddy, simpler) vs SSH (better Obsidian Git
  plugin support). Lean HTTPS first, add SSH if needed.
- **Container lifecycle**: Keep workspace container running 24/7 vs start/stop per session.
  24/7 is simpler (no startup latency, vault always mounted). Start with always-on.
- **OAuth polling endpoint**: Needs to be confirmed by inspecting CLI network traffic before
  Phase 6. If no clean polling API exists, the token-paste flow (Phase 2) is the permanent UX.
- **Multiple concurrent sessions**: Out of scope for now. Single active session at a time.
  Session interrupts the previous one if another is started.
